	</section>
	<section id="overlay-wrapper" class="hidden">
		<section id="overlay-background"></section>
		<section id="overlay-main">
			<div class="close">×</div>
			<div class="overlay-header">
				<h2 class="name"></h2>
				<h3><a class="id" href"#"></a></h3>
			</div>
			<div class="body">
				<div class="note"></div>
				<div class="tasks"></div>
		</section>
	</section>
	<section id="modal-wrapper" class="hidden">
		<section id="modal-background"></section>
		<section id="modal-main">
			<div class="close">×</div>
			<h2 class="title"></h2>
			<div class="body"></div>
		</section>
	</section>
	<script>
	//Give us a favicon!
	var favicon = document.querySelector("head link");
	favicon.setAttribute("href", "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAEJGlDQ1BJQ0MgUHJvZmlsZQAAOBGFVd9v21QUPolvUqQWPyBYR4eKxa9VU1u5GxqtxgZJk6XtShal6dgqJOQ6N4mpGwfb6baqT3uBNwb8AUDZAw9IPCENBmJ72fbAtElThyqqSUh76MQPISbtBVXhu3ZiJ1PEXPX6yznfOec7517bRD1fabWaGVWIlquunc8klZOnFpSeTYrSs9RLA9Sr6U4tkcvNEi7BFffO6+EdigjL7ZHu/k72I796i9zRiSJPwG4VHX0Z+AxRzNRrtksUvwf7+Gm3BtzzHPDTNgQCqwKXfZwSeNHHJz1OIT8JjtAq6xWtCLwGPLzYZi+3YV8DGMiT4VVuG7oiZpGzrZJhcs/hL49xtzH/Dy6bdfTsXYNY+5yluWO4D4neK/ZUvok/17X0HPBLsF+vuUlhfwX4j/rSfAJ4H1H0qZJ9dN7nR19frRTeBt4Fe9FwpwtN+2p1MXscGLHR9SXrmMgjONd1ZxKzpBeA71b4tNhj6JGoyFNp4GHgwUp9qplfmnFW5oTdy7NamcwCI49kv6fN5IAHgD+0rbyoBc3SOjczohbyS1drbq6pQdqumllRC/0ymTtej8gpbbuVwpQfyw66dqEZyxZKxtHpJn+tZnpnEdrYBbueF9qQn93S7HQGGHnYP7w6L+YGHNtd1FJitqPAR+hERCNOFi1i1alKO6RQnjKUxL1GNjwlMsiEhcPLYTEiT9ISbN15OY/jx4SMshe9LaJRpTvHr3C/ybFYP1PZAfwfYrPsMBtnE6SwN9ib7AhLwTrBDgUKcm06FSrTfSj187xPdVQWOk5Q8vxAfSiIUc7Z7xr6zY/+hpqwSyv0I0/QMTRb7RMgBxNodTfSPqdraz/sDjzKBrv4zu2+a2t0/HHzjd2Lbcc2sG7GtsL42K+xLfxtUgI7YHqKlqHK8HbCCXgjHT1cAdMlDetv4FnQ2lLasaOl6vmB0CMmwT/IPszSueHQqv6i/qluqF+oF9TfO2qEGTumJH0qfSv9KH0nfS/9TIp0Wboi/SRdlb6RLgU5u++9nyXYe69fYRPdil1o1WufNSdTTsp75BfllPy8/LI8G7AUuV8ek6fkvfDsCfbNDP0dvRh0CrNqTbV7LfEEGDQPJQadBtfGVMWEq3QWWdufk6ZSNsjG2PQjp3ZcnOWWing6noonSInvi0/Ex+IzAreevPhe+CawpgP1/pMTMDo64G0sTCXIM+KdOnFWRfQKdJvQzV1+Bt8OokmrdtY2yhVX2a+qrykJfMq4Ml3VR4cVzTQVz+UoNne4vcKLoyS+gyKO6EHe+75Fdt0Mbe5bRIf/wjvrVmhbqBN97RD1vxrahvBOfOYzoosH9bq94uejSOQGkVM6sN/7HelL4t10t9F4gPdVzydEOx83Gv+uNxo7XyL/FtFl8z9ZAHF4bBsrEwAAAAlwSFlzAAALEwAACxMBAJqcGAAAARdJREFUOBGVU00SwVAMlseqCxasXMI4ghkHcAjHqBXuwwm4gnOwYNOd9+RLJVKtIjOZ5r0v35eftpRS6vxhgXOJPbILsadkIlrppd61PbnwhnGiZwd0Oed3JRz3p85sMWUooprYYYe7icTMug5H2yEOaAlWmQNTeTLjaNkZ9fkATlIBByK0wkp0eYHFrTA5oNQIYcCBNVTDSywgAVXqHcR4480Qe8Z4A1/EZTciYm+Bs82w2JSK51mqYQsYB1W9amoUMCUJYjlPkHFtOZqjrxFt53r5wxO8teSV7aLlqjO4Ws7HEY74Hdezn6dSOMuwxO/2UaAodIntIipQW04LresxFbAvx4MNMQrZPwNcBRpyX1chWFqt0APk/nSDodA5MgAAAABJRU5ErkJggg==");
	
	//Foreach function
	function foreach(sel, fnc){
		var elems;
		if (sel instanceof Array || sel instanceof NodeList) elems = sel;
		else elems=document.querySelectorAll(sel);

		for(var i=0;i<elems.length;i++)fnc(elems[i]);
	}

	//Add class to element
	function addClass(elem, klass) {
		var klasses = elem.className.split(/\s+/);

		if (klasses.indexOf(klass) == -1) {
			klasses.push(klass);
			elem.className = klasses.join(" ");
		}
	}

	function removeClass(elem, klass) {
		var klasses = elem.className.split(/\s+/);
		var i = klasses.indexOf(klass);

		if (i >= 0) {
			klasses.splice(i,1);
			elem.className = klasses.join(" ");
		}
	}

	//Element hide and show
	function show(elem){ removeClass(elem, "hidden") }
	function hide(elem){ addClass(elem, "hidden") }

	//Overlay vars	
	var overlay = {
		wrapper: document.querySelector("#overlay-wrapper"),
		background: document.querySelector("#overlay-background"),
		container: document.querySelector("#overlay-main"),
		name: document.querySelector("#overlay-main .name"),
		id: document.querySelector("#overlay-main .id"),
		note: document.querySelector("#overlay-main .note"),
		tasks: document.querySelector("#overlay-main .tasks"),
		close: document.querySelector("#overlay-main .close")
	};

	//Show the overlay, get data from element
	function showOverlay(elem) {
		overlay.container.style.backgroundColor = elem.getAttribute("data-light-colour");

		overlay.name.innerHTML = elem.getAttribute("data-name");
		overlay.id.innerHTML = elem.getAttribute("data-id");
		overlay.id.setAttribute("href", "omnifocus:///task/"+elem.getAttribute("data-id"));

		//Set up note panel inner HTML. Optional UL for deferral and due dates,
		// followed by notes
		var noteHTML = "";
		if (elem.getAttribute("data-deferred") != "" ||
				elem.getAttribute("data-due") 		 != "") {
			noteHTML = "<ul>";
			if (elem.getAttribute("data-deferred") != "") { noteHTML += "<li><b>Project deferred until:</b> " + elem.getAttribute("data-deferred") + "</li>"; }
			if (elem.getAttribute("data-due") != "") 			{ noteHTML += "<li><b>Project due on:</b> " + elem.getAttribute("data-due") + "</li>"; }
			noteHTML += "</ul>"
		}
		overlay.note.innerHTML = noteHTML + "<h3>Notes:</h3>" + elem.getAttribute("data-note");
		overlay.tasks.innerHTML = "<h3>Tasks:</h3>" + elem.getAttribute("data-tasks");

		show(overlay.wrapper);
	}

	// Hide the overlay
	function hideOverlay() {hide(overlay.wrapper); }

	// Set element background colour
	foreach(".project", function(p){ p.style.backgroundColor = p.getAttribute("data-colour");});

	// Set up title click->overlay
	foreach(".project h4", function(h){
		h.style.cursor = "pointer";
		h.addEventListener("click", function(){showOverlay(h.parentNode)},false);
	});

	// Modal vars
	var modal = {
		wrapper: document.querySelector("#modal-wrapper"),
		background: document.querySelector("#modal-background"),
		container: document.querySelector("#modal-main"),
		title: document.querySelector("#modal-main .title"),
		body: document.querySelector("#modal-main .body"),
		close: document.querySelector("#modal-main .close")
	}

	// Show the modal, with a title and body
	function showModal(title, body) {
		modal.title.innerHTML = title;
		modal.body.innerHTML = body;

		show(modal.wrapper);
	}

	// Hide the modal
	function hideModal(){ hide(modal.wrapper); }

	//Background and close button listeners
	modal.close.addEventListener("click", hideModal, false);
	modal.background.addEventListener("click", hideModal, false);

	//Hook up alerts to modal
	foreach(".alert", function(alert){
		alert.addEventListener("click", function(){
			showModal(this.getAttribute("data-modal-title"), this.getAttribute("data-modal-body"));
		}, false);
	});

	// Search box function
	document.querySelector("#search").addEventListener("keyup", function(){
		var searchString = this.value.toLowerCase();

		foreach(".project", function(p){
			var id = p.getAttribute("data-id");
			var name = p.getAttribute("data-name");
			var note = p.getAttribute("data-note");
			if (name.toLowerCase().indexOf(searchString) >= 0 ||
					id.toLowerCase().indexOf(searchString) >= 0 ||
					note.toLowerCase().indexOf(searchString) >= 0
				)
				show(p);
			else
				hide(p);
		});
		updateGroupVisibility();
	});

	// Close button listener
	overlay.close.addEventListener("click", hideOverlay, false);
	// Overlay background listener
	overlay.background.addEventListener("click", hideOverlay, false);

	// Search box auto-focus with "/" when not focussed on a textbox
	document.addEventListener("keypress", function(e){
		if (!e) //IE fix
			e = window.event;

		// Escape most things
		var tagName = e.target.tagName;
		if (tagName == "INPUT" || tagName == "TEXTAREA") return true;
		if (e.shiftKey || e.ctrlKey || e.altKey) return true;

		if (e.key == "/") {
			document.querySelector("#search").focus();
			return false;
		}
		else
			return true;
	}, true);

	//Automatically filter dimmed projects on load 
	document.addEventListener("DOMContentLoaded", hideOnStart, false);
	function hideOnStart() {
		foreach(".filter-button", function(elem){
				var parent = elem.parentNode.parentNode;
				var dimmedProjects = parent.querySelectorAll(".dimmed");
				var use = elem.querySelector("use");
				var countHidden = elem.querySelector("text");
				var numHidden = 0;

				//alert(dimmedProjects);
				foreach(dimmedProjects, function(e){ 
					addClass(e, "filtered"); 
					++numHidden;
				});
				use.setAttribute("xlink:href", "#filter-remove");
				
				if (numHidden > 0) {
					countHidden.innerHTML = "(" + numHidden + ")";
				}

				updateGroupVisibility();
			});
	}

	// Filter button listeners
	foreach(".filter-button", function(elem){
		elem.addEventListener("click", function(){
			var parent = this.parentNode.parentNode;
			var use = this.querySelector("use");

			var dimmedProjects = parent.querySelectorAll(".dimmed");
			if (use.getAttribute("xlink:href") == "#filter-apply") {// Apply filter!
				foreach(dimmedProjects, function(e){ addClass(e, "filtered") });
				use.setAttribute("xlink:href", "#filter-remove");
			}
			else {
				foreach(dimmedProjects, function(e){ removeClass(e, "filtered") });
				use.setAttribute("xlink:href", "#filter-apply");
			}

			updateGroupVisibility();
		}, false);
	});

	// Hide/show groups
	function updateGroupVisibility() {
		foreach(".project-wrapper", function(pw){

			var projects = pw.querySelectorAll(".project");
			var allProjectsHidden = true;
			var j = 0;

			while (allProjectsHidden && j < projects.length) {
				if (projects[j].className.indexOf("hidden") == -1 && projects[j].className.indexOf("filtered") == -1)
					allProjectsHidden = false;
				j++;
			}

			if (allProjectsHidden) hide(pw);
			else show(pw);
		});
	}
	</script>
</body>
</html>